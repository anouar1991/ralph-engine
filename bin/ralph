#!/usr/bin/env bash
#
# ralph - Autonomous task executor for Claude Code
#
# Uses PRD-driven development with git as memory and Claude as executor.
# Each iteration: read PRD -> pick task -> execute -> commit -> verify
#

set -euo pipefail

# Version
readonly RALPH_VERSION="1.3.0"

# Determine script location for library loading
RALPH_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
readonly RALPH_ROOT

# Source core library
# shellcheck source=../lib/ralph-core.sh
source "${RALPH_ROOT}/lib/ralph-core.sh"

# Source watch library
# shellcheck source=../lib/ralph-watch.sh
source "${RALPH_ROOT}/lib/ralph-watch.sh"

# Default configuration
DEFAULT_MAX_ITERATIONS=50
DEFAULT_TIMEOUT=900
DEFAULT_PRD_FILE="prd.json"
DEFAULT_OUTPUT_DIR="/tmp/ralph"

# Runtime configuration (set by parse_args)
MAX_ITERATIONS=""
ITERATION_TIMEOUT=""
PRD_FILE=""
OUTPUT_DIR=""
PROJECT_DIR=""
QUIET_MODE=false
NO_VERIFY=false
DRY_RUN=false
SUDO_PASS_VAR=""

# Init command configuration
GOAL_TEXT=""
GOAL_FILE=""
INIT_OUTPUT_DIR=""

# Main usage/help
usage() {
    cat <<EOF
ralph - Autonomous task executor for Claude Code

USAGE:
    ralph [OPTIONS] [PROJECT_DIR]        Run the task loop
    ralph init [OPTIONS] <GOAL>          Generate prd.json from a goal
    ralph extend [OPTIONS] <GOAL>        Add tasks to completed project
    ralph status [PROJECT_DIR]           Show project status
    ralph stack [PROJECT_DIR]            Show PRD stack status
    ralph watch [PROJECT_DIR]            Real-time task visualization
    ralph flow [PROJECT_DIR]             Task dependency flow diagram

COMMANDS:
    run (default)    Execute the Ralph loop on a project
    init             Generate a prd.json from a goal description
    extend           Add new tasks to a completed project
    status           Show current project progress
    stack            Show PRD expansion stack status
    watch            Live dashboard showing task progress
    flow             Dependency flow visualization

Run 'ralph <command> --help' for command-specific help.

QUICK START:
    ralph init "Build a CLI tool for managing todos"
    ralph flow       # View task dependency tree
    ralph watch &    # Start live dashboard in background
    ralph            # Run the task loop

EXTENDING PROJECTS:
    ralph extend "Add CSV export feature"  # After project is complete

For more information, see: https://github.com/anouar1991/ralph-engine

EOF
}

usage_run() {
    cat <<EOF
ralph run - Execute the Ralph loop

USAGE:
    ralph [run] [OPTIONS] [PROJECT_DIR] [-- CLAUDE_ARGS...]

ARGUMENTS:
    PROJECT_DIR    Directory containing prd.json (default: current directory)
    CLAUDE_ARGS    Extra arguments passed directly to claude (after --)

OPTIONS:
    -n, --max-iterations NUM    Maximum iterations (default: $DEFAULT_MAX_ITERATIONS)
    -t, --timeout SECONDS       Timeout per iteration (default: $DEFAULT_TIMEOUT)
    -p, --prd FILE              PRD file name (default: $DEFAULT_PRD_FILE)
    -o, --output DIR            Output directory for logs (default: $DEFAULT_OUTPUT_DIR)
    -q, --quiet                 Minimal output
        --no-verify             Skip verification step after each iteration
        --no-expand             Disable automatic task expansion into sub-PRDs
        --no-optimizer          Disable pre-iteration task optimizer (haiku briefing)
        --expansion-threshold N Complexity threshold for auto-expansion (default: 4)
        --max-stack-depth N     Maximum nested sub-PRD depth (default: 3)
        --sudo-pass [VAR]       Enable sudo password piping from env var (default: RALPH_SUDO_PASS)
        --dry-run               Show what would be done without executing
    -h, --help                  Show this help message

ENVIRONMENT VARIABLES:
    RALPH_MAX_ITERATIONS      Override default max iterations
    RALPH_TIMEOUT             Override default timeout
    RALPH_OUTPUT_DIR          Override default output directory
    RALPH_SUDO_PASS           Sudo password for privileged commands (with --sudo-pass)
    RALPH_NO_EXPAND           Disable automatic expansion (true/false)
    RALPH_NO_OPTIMIZER        Disable pre-iteration optimizer (true/false)
    RALPH_EXPANSION_THRESHOLD Override expansion threshold
    RALPH_MAX_STACK_DEPTH     Override max stack depth
    RALPH_CLAUDE_ARGS         Extra arguments to pass to claude command
    NO_COLOR                  Disable colored output

EXAMPLES:
    ralph                           # Run in current directory
    ralph ~/my-project              # Run in specific directory
    ralph -n 100 -t 1800            # 100 iterations, 30min timeout each
    ralph --dry-run                 # Preview without executing
    ralph --no-expand               # Disable automatic task expansion
    ralph --no-optimizer            # Disable pre-iteration task briefing
    ralph --expansion-threshold 5   # Only expand tasks with complexity >= 5
    ralph --sudo-pass               # Enable sudo with RALPH_SUDO_PASS env var
    ralph -- --allowedTools Bash    # Pass --allowedTools to claude
    ralph -- --dangerously-skip-permissions  # Skip claude permission prompts

EOF
}

usage_init() {
    cat <<EOF
ralph init - Generate prd.json from a goal description

USAGE:
    ralph init [OPTIONS] <GOAL> [-- CLAUDE_ARGS...]
    ralph init [OPTIONS] -f <FILE> [-- CLAUDE_ARGS...]

ARGUMENTS:
    GOAL         Goal description as text (quote multi-word goals)
    CLAUDE_ARGS  Extra arguments passed directly to claude (after --)

OPTIONS:
    -f, --file FILE       Read goal from file instead of argument
    -d, --dir DIR         Output directory for prd.json (default: current directory)
    -p, --prd FILE        Output PRD file name (default: $DEFAULT_PRD_FILE)
        --complexity NUM  Target number of tasks (default: auto)
        --dry-run         Show generated PRD without writing
    -h, --help            Show this help message

EXAMPLES:
    ralph init "Build a REST API for user management"
    ralph init -f requirements.txt -d ~/my-project
    ralph init "Create a CLI todo app" --complexity 20
    ralph init -f goal.md --dry-run
    ralph init "Scrape website data" -- --chrome

GOAL FILE FORMAT:
    The goal file can be plain text or markdown describing:
    - What the project should do
    - Key features and requirements
    - Technical constraints (language, framework, etc.)
    - Any specific considerations

EOF
}

usage_status() {
    cat <<EOF
ralph status - Show project progress

USAGE:
    ralph status [PROJECT_DIR]

ARGUMENTS:
    PROJECT_DIR    Directory containing prd.json (default: current directory)

OPTIONS:
    -p, --prd FILE    PRD file name (default: $DEFAULT_PRD_FILE)
    -h, --help        Show this help message

EOF
}

usage_stack() {
    cat <<EOF
ralph stack - Show PRD expansion stack status

USAGE:
    ralph stack [PROJECT_DIR]

ARGUMENTS:
    PROJECT_DIR    Directory containing prd.json (default: current directory)

OPTIONS:
    -p, --prd FILE    PRD file name (default: $DEFAULT_PRD_FILE)
    -h, --help        Show this help message

DESCRIPTION:
    Shows the current state of the PRD expansion stack, including:
    - Current stack depth
    - Active PRD file (main or sub-PRD)
    - Parent tasks that have been expanded
    - When each expansion was started

    This is useful for understanding where Ralph is in the task hierarchy
    when working with complex tasks that have been automatically expanded
    into sub-PRDs.

EXAMPLES:
    ralph stack                     # Show stack for current directory
    ralph stack ~/my-project        # Show stack for specific project

EOF
}

usage_watch() {
    cat <<EOF
ralph watch - Real-time task visualization dashboard

USAGE:
    ralph watch [OPTIONS] [PROJECT_DIR]

ARGUMENTS:
    PROJECT_DIR    Directory containing prd.json (default: current directory)

OPTIONS:
    -p, --prd FILE        PRD file name (default: $DEFAULT_PRD_FILE)
    -r, --refresh SECS    Refresh interval in seconds (default: 2)
    -h, --help            Show this help message

DESCRIPTION:
    Provides a beautiful real-time terminal dashboard showing:
    - Overall progress with progress bar
    - Task list with status icons (done/working/pending/blocked)
    - Complexity indicators for each task
    - Sub-PRD stack status when expanding tasks
    - Recent git activity

    The display updates automatically at the specified refresh interval.
    Press Ctrl+C to exit.

TASK STATUS ICONS:
    $ICON_DONE  Done       - Task completed successfully
    $ICON_WORKING  Working    - Task currently in progress
    $ICON_PENDING  Ready      - Task ready to start (dependencies met)
    $ICON_BLOCKED  Blocked    - Waiting on dependencies
    $ICON_EXPANDING  Expanding  - Task expanded into sub-PRD

EXAMPLES:
    ralph watch                     # Watch current project
    ralph watch ~/my-project        # Watch specific project
    ralph watch -r 5                # Refresh every 5 seconds
    ralph watch & ralph             # Run dashboard alongside ralph

EOF
}

usage_flow() {
    cat <<EOF
ralph flow - Task dependency flow visualization

USAGE:
    ralph flow [OPTIONS] [PROJECT_DIR]

ARGUMENTS:
    PROJECT_DIR    Directory containing prd.json (default: current directory)

OPTIONS:
    -p, --prd FILE        PRD file name (default: $DEFAULT_PRD_FILE)
    -r, --refresh SECS    Refresh interval in seconds (default: 2)
    -h, --help            Show this help message

DESCRIPTION:
    Shows a visual tree of task dependencies, from the project goal
    down through the task hierarchy. Useful for understanding:
    - Which tasks have no dependencies (can start immediately)
    - How tasks depend on each other
    - The critical path through your project

    The display updates automatically. Press Ctrl+C to exit.

FLOW DIAGRAM:
    ◆ Project Goal
    │
    ├──▶ ✓ T-100 (root task, no dependencies)
    │   └──▶ ○ T-200 (depends on T-100)
    │       └──▶ ◌ T-300 (depends on T-200)
    └──▶ ✓ T-110 (another root task)

LEGEND:
    ◆  Project goal
    ✓  Task completed
    ○  Task ready (dependencies met)
    ◌  Task blocked (waiting on dependencies)

EXAMPLES:
    ralph flow                      # View flow for current project
    ralph flow ~/my-project         # View flow for specific project
    ralph flow -r 5                 # Refresh every 5 seconds

EOF
}

usage_extend() {
    cat <<EOF
ralph extend - Add new tasks to a completed project

USAGE:
    ralph extend [OPTIONS] <GOAL> [-- CLAUDE_ARGS...]
    ralph extend [OPTIONS] -f <FILE> [-- CLAUDE_ARGS...]

ARGUMENTS:
    GOAL         Goal description for new features/changes (quote multi-word goals)
    CLAUDE_ARGS  Extra arguments passed directly to claude (after --)

OPTIONS:
    -f, --file FILE       Read goal from file instead of argument
    -d, --dir DIR         Project directory (default: current directory)
    -p, --prd FILE        PRD file name (default: $DEFAULT_PRD_FILE)
        --dry-run         Show generated tasks without writing
    -h, --help            Show this help message

DESCRIPTION:
    Extends an already-completed project with new tasks. This allows iterative
    development where you can add features, make changes, or enhance existing
    work after the initial implementation is complete.

    New task IDs start from the next hundred boundary (e.g., if max task is
    T-450, new tasks start at T-500) to prevent ID collisions.

    New tasks can depend on completed tasks and leverage existing guarantees.

EXAMPLES:
    ralph extend "Add CSV export functionality"
    ralph extend "Add dark mode support" -d ~/my-project
    ralph extend -f new-features.md --dry-run
    ralph extend "Add caching layer" -- --chrome

REQUIREMENTS:
    - PRD file must exist
    - Project must have at least one completed task
    - Use 'ralph' to execute existing tasks before extending

EOF
}

version() {
    echo "ralph $RALPH_VERSION"
}

# Extra arguments to pass to claude
CLAUDE_EXTRA_ARGS=""

# Parse run command arguments
parse_run_args() {
    # Apply environment variable defaults
    MAX_ITERATIONS="${RALPH_MAX_ITERATIONS:-$DEFAULT_MAX_ITERATIONS}"
    ITERATION_TIMEOUT="${RALPH_TIMEOUT:-$DEFAULT_TIMEOUT}"
    OUTPUT_DIR="${RALPH_OUTPUT_DIR:-$DEFAULT_OUTPUT_DIR}"
    PRD_FILE="$DEFAULT_PRD_FILE"
    PROJECT_DIR="."

    # Extra claude args from environment or empty
    CLAUDE_EXTRA_ARGS="${RALPH_CLAUDE_ARGS:-}"

    # Expansion configuration (exported for use in ralph-core.sh)
    export RALPH_NO_EXPAND="${RALPH_NO_EXPAND:-false}"
    export RALPH_EXPANSION_THRESHOLD="${RALPH_EXPANSION_THRESHOLD:-4}"
    export RALPH_MAX_STACK_DEPTH="${RALPH_MAX_STACK_DEPTH:-3}"

    # Optimizer configuration
    export RALPH_NO_OPTIMIZER="${RALPH_NO_OPTIMIZER:-false}"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--max-iterations)
                MAX_ITERATIONS="$2"
                shift 2
                ;;
            -t|--timeout)
                ITERATION_TIMEOUT="$2"
                shift 2
                ;;
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            -o|--output)
                OUTPUT_DIR="$2"
                shift 2
                ;;
            -q|--quiet)
                QUIET_MODE=true
                shift
                ;;
            --no-verify)
                NO_VERIFY=true
                shift
                ;;
            --no-expand)
                export RALPH_NO_EXPAND=true
                shift
                ;;
            --no-optimizer)
                export RALPH_NO_OPTIMIZER=true
                shift
                ;;
            --expansion-threshold)
                export RALPH_EXPANSION_THRESHOLD="$2"
                shift 2
                ;;
            --max-stack-depth)
                export RALPH_MAX_STACK_DEPTH="$2"
                shift 2
                ;;
            --sudo-pass)
                # Check if next arg is a custom var name (not another flag)
                if [[ -n "${2:-}" ]] && [[ ! "$2" =~ ^- ]]; then
                    SUDO_PASS_VAR="$2"
                    shift 2
                else
                    SUDO_PASS_VAR="RALPH_SUDO_PASS"
                    shift
                fi
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            -h|--help)
                usage_run
                exit 0
                ;;
            -v|--version)
                version
                exit 0
                ;;
            --)
                # Everything after -- is passed to claude
                shift
                CLAUDE_EXTRA_ARGS="$*"
                break
                ;;
            -*)
                error "Unknown option: $1"
                echo "Use 'ralph run --help' for usage information."
                exit 1
                ;;
            *)
                PROJECT_DIR="$1"
                shift
                ;;
        esac
    done

    # Validate numeric arguments
    if ! [[ "$MAX_ITERATIONS" =~ ^[0-9]+$ ]]; then
        error "Invalid max-iterations: $MAX_ITERATIONS (must be a number)"
        exit 1
    fi
    if ! [[ "$ITERATION_TIMEOUT" =~ ^[0-9]+$ ]]; then
        error "Invalid timeout: $ITERATION_TIMEOUT (must be a number)"
        exit 1
    fi

    # Resolve project directory
    local original_dir="$PROJECT_DIR"
    PROJECT_DIR="$(cd "$original_dir" 2>/dev/null && pwd)" || {
        error "Project directory not found: $original_dir"
        exit 1
    }

    # Full path to PRD file
    PRD_FILE="$PROJECT_DIR/$PRD_FILE"
}

# Parse init command arguments
parse_init_args() {
    INIT_OUTPUT_DIR="."
    PRD_FILE="$DEFAULT_PRD_FILE"
    CLAUDE_EXTRA_ARGS="${RALPH_CLAUDE_ARGS:-}"
    local complexity=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--file)
                GOAL_FILE="$2"
                shift 2
                ;;
            -d|--dir)
                INIT_OUTPUT_DIR="$2"
                shift 2
                ;;
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            --complexity)
                complexity="$2"
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            -h|--help)
                usage_init
                exit 0
                ;;
            --)
                # Everything after -- is passed to claude
                shift
                CLAUDE_EXTRA_ARGS="$*"
                break
                ;;
            -*)
                error "Unknown option: $1"
                echo "Use 'ralph init --help' for usage information."
                exit 1
                ;;
            *)
                GOAL_TEXT="$1"
                shift
                ;;
        esac
    done

    # Validate we have a goal
    if [[ -z "$GOAL_TEXT" ]] && [[ -z "$GOAL_FILE" ]]; then
        error "No goal specified. Provide a goal as argument or use -f FILE."
        echo ""
        usage_init
        exit 1
    fi

    # Read goal from file if specified
    if [[ -n "$GOAL_FILE" ]]; then
        if [[ ! -f "$GOAL_FILE" ]]; then
            error "Goal file not found: $GOAL_FILE"
            exit 1
        fi
        GOAL_TEXT=$(cat "$GOAL_FILE")
    fi

    # Create output directory if needed
    if [[ ! -d "$INIT_OUTPUT_DIR" ]]; then
        mkdir -p "$INIT_OUTPUT_DIR"
    fi
    INIT_OUTPUT_DIR="$(cd "$INIT_OUTPUT_DIR" && pwd)"

    # Store complexity if specified
    if [[ -n "$complexity" ]]; then
        export RALPH_TARGET_COMPLEXITY="$complexity"
    fi
}

# Parse status command arguments
parse_status_args() {
    PRD_FILE="$DEFAULT_PRD_FILE"
    PROJECT_DIR="."

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            -h|--help)
                usage_status
                exit 0
                ;;
            -*)
                error "Unknown option: $1"
                exit 1
                ;;
            *)
                PROJECT_DIR="$1"
                shift
                ;;
        esac
    done

    local original_dir="$PROJECT_DIR"
    PROJECT_DIR="$(cd "$original_dir" 2>/dev/null && pwd)" || {
        error "Project directory not found: $original_dir"
        exit 1
    }
    PRD_FILE="$PROJECT_DIR/$PRD_FILE"
}

# Parse stack command arguments
parse_stack_args() {
    PRD_FILE="$DEFAULT_PRD_FILE"
    PROJECT_DIR="."

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            -h|--help)
                usage_stack
                exit 0
                ;;
            -*)
                error "Unknown option: $1"
                exit 1
                ;;
            *)
                PROJECT_DIR="$1"
                shift
                ;;
        esac
    done

    local original_dir="$PROJECT_DIR"
    PROJECT_DIR="$(cd "$original_dir" 2>/dev/null && pwd)" || {
        error "Project directory not found: $original_dir"
        exit 1
    }
    PRD_FILE="$PROJECT_DIR/$PRD_FILE"
}

# Parse watch command arguments
WATCH_REFRESH_INTERVAL=2

parse_watch_args() {
    PRD_FILE="$DEFAULT_PRD_FILE"
    PROJECT_DIR="."
    WATCH_REFRESH_INTERVAL=2

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            -r|--refresh)
                WATCH_REFRESH_INTERVAL="$2"
                shift 2
                ;;
            -h|--help)
                usage_watch
                exit 0
                ;;
            -*)
                error "Unknown option: $1"
                exit 1
                ;;
            *)
                PROJECT_DIR="$1"
                shift
                ;;
        esac
    done

    # Validate refresh interval
    if ! [[ "$WATCH_REFRESH_INTERVAL" =~ ^[0-9]+$ ]]; then
        error "Invalid refresh interval: $WATCH_REFRESH_INTERVAL (must be a number)"
        exit 1
    fi

    local original_dir="$PROJECT_DIR"
    PROJECT_DIR="$(cd "$original_dir" 2>/dev/null && pwd)" || {
        error "Project directory not found: $original_dir"
        exit 1
    }
    PRD_FILE="$PROJECT_DIR/$PRD_FILE"
}

# Parse flow command arguments
FLOW_REFRESH_INTERVAL=2

parse_flow_args() {
    PRD_FILE="$DEFAULT_PRD_FILE"
    PROJECT_DIR="."
    FLOW_REFRESH_INTERVAL=2

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            -r|--refresh)
                FLOW_REFRESH_INTERVAL="$2"
                shift 2
                ;;
            -h|--help)
                usage_flow
                exit 0
                ;;
            -*)
                error "Unknown option: $1"
                exit 1
                ;;
            *)
                PROJECT_DIR="$1"
                shift
                ;;
        esac
    done

    # Validate refresh interval
    if ! [[ "$FLOW_REFRESH_INTERVAL" =~ ^[0-9]+$ ]]; then
        error "Invalid refresh interval: $FLOW_REFRESH_INTERVAL (must be a number)"
        exit 1
    fi

    local original_dir="$PROJECT_DIR"
    PROJECT_DIR="$(cd "$original_dir" 2>/dev/null && pwd)" || {
        error "Project directory not found: $original_dir"
        exit 1
    }
    PRD_FILE="$PROJECT_DIR/$PRD_FILE"
}

# Extend command configuration
EXTEND_GOAL_TEXT=""
EXTEND_GOAL_FILE=""
EXTEND_OUTPUT_DIR=""

# Parse extend command arguments
parse_extend_args() {
    EXTEND_OUTPUT_DIR="."
    PRD_FILE="$DEFAULT_PRD_FILE"
    CLAUDE_EXTRA_ARGS="${RALPH_CLAUDE_ARGS:-}"
    EXTEND_GOAL_TEXT=""
    EXTEND_GOAL_FILE=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--file)
                EXTEND_GOAL_FILE="$2"
                shift 2
                ;;
            -d|--dir)
                EXTEND_OUTPUT_DIR="$2"
                shift 2
                ;;
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            -h|--help)
                usage_extend
                exit 0
                ;;
            --)
                # Everything after -- is passed to claude
                shift
                CLAUDE_EXTRA_ARGS="$*"
                break
                ;;
            -*)
                error "Unknown option: $1"
                echo "Use 'ralph extend --help' for usage information."
                exit 1
                ;;
            *)
                EXTEND_GOAL_TEXT="$1"
                shift
                ;;
        esac
    done

    # Validate we have a goal
    if [[ -z "$EXTEND_GOAL_TEXT" ]] && [[ -z "$EXTEND_GOAL_FILE" ]]; then
        error "No goal specified. Provide a goal as argument or use -f FILE."
        echo ""
        usage_extend
        exit 1
    fi

    # Read goal from file if specified
    if [[ -n "$EXTEND_GOAL_FILE" ]]; then
        if [[ ! -f "$EXTEND_GOAL_FILE" ]]; then
            error "Goal file not found: $EXTEND_GOAL_FILE"
            exit 1
        fi
        EXTEND_GOAL_TEXT=$(cat "$EXTEND_GOAL_FILE")
    fi

    # Resolve project directory
    if [[ ! -d "$EXTEND_OUTPUT_DIR" ]]; then
        error "Project directory not found: $EXTEND_OUTPUT_DIR"
        exit 1
    fi
    EXTEND_OUTPUT_DIR="$(cd "$EXTEND_OUTPUT_DIR" && pwd)"
}

# Validate environment for run command
validate_env() {
    # Check for claude CLI
    if ! command -v claude &>/dev/null; then
        error "claude CLI not found in PATH"
        echo "Install Claude Code: https://claude.ai/code"
        exit 1
    fi

    # Check for jq
    if ! command -v jq &>/dev/null; then
        error "jq not found in PATH"
        echo "Install jq: https://stedolan.github.io/jq/download/"
        exit 1
    fi

    # Check for git
    if ! command -v git &>/dev/null; then
        error "git not found in PATH"
        exit 1
    fi

    # Check PRD file exists
    if [[ ! -f "$PRD_FILE" ]]; then
        error "PRD file not found: $PRD_FILE"
        echo ""
        echo "Create one with: ralph init \"Your project goal\""
        exit 1
    fi

    # Validate PRD JSON
    if ! jq empty "$PRD_FILE" 2>/dev/null; then
        error "Invalid JSON in PRD file: $PRD_FILE"
        exit 1
    fi

    # Check tasks array exists
    if ! jq -e '.tasks' "$PRD_FILE" &>/dev/null; then
        error "PRD file missing 'tasks' array"
        exit 1
    fi
}

# Initialize git if needed
init_git() {
    cd "$PROJECT_DIR" || exit 1

    if [[ ! -d ".git" ]]; then
        info "Initializing git repository..."
        git init
        git add -A
        git commit -m "Initial commit: PRD and project setup"
    fi
}

# Show configuration
show_config() {
    if [[ "$QUIET_MODE" == true ]]; then
        return
    fi

    local task_count
    task_count=$(jq '.tasks | length' "$PRD_FILE")
    local completed
    completed=$(jq '[.tasks[] | select(.pass == true)] | length' "$PRD_FILE")

    # Check for active sub-PRD
    local active_sub
    active_sub=$(jq -r '.ralph.activeSubPrdFile // empty' "$PRD_FILE" 2>/dev/null)
    local stack_depth
    stack_depth=$(jq '.ralph.prdStack | length // 0' "$PRD_FILE" 2>/dev/null || echo 0)

    banner "RALPH ENGINE v$RALPH_VERSION"
    echo ""
    info "Configuration:"
    echo "  Project:      $PROJECT_DIR"
    echo "  PRD File:     $PRD_FILE"
    echo "  Tasks:        $completed/$task_count complete"
    echo "  Max Iter:     $MAX_ITERATIONS"
    echo "  Timeout:      ${ITERATION_TIMEOUT}s per iteration"
    echo "  Output:       $OUTPUT_DIR"
    echo "  Verify:       $([[ "$NO_VERIFY" == true ]] && echo "disabled" || echo "enabled")"
    echo "  Optimizer:    $([[ "$RALPH_NO_OPTIMIZER" == true ]] && echo "disabled" || echo "enabled")"
    echo "  Sudo:         $([[ -n "$SUDO_PASS_VAR" ]] && echo "enabled (\$$SUDO_PASS_VAR)" || echo "disabled")"
    echo ""
    info "Expansion Settings:"
    echo "  Auto-expand:  $([[ "$RALPH_NO_EXPAND" == true ]] && echo "disabled" || echo "enabled")"
    echo "  Threshold:    complexity >= $RALPH_EXPANSION_THRESHOLD with 5+ actions"
    echo "  Max Depth:    $RALPH_MAX_STACK_DEPTH nested sub-PRDs"
    if [[ -n "$active_sub" ]]; then
        echo ""
        echo -e "  ${YELLOW}Active Sub-PRD: $active_sub (depth: $stack_depth)${NC}"
    fi
    if [[ -n "$CLAUDE_EXTRA_ARGS" ]]; then
        echo ""
        info "Claude Extra Args:"
        echo "  $CLAUDE_EXTRA_ARGS"
    fi
    echo ""
}

# Run command
cmd_run() {
    parse_run_args "$@"

    # Dry run mode
    if [[ "$DRY_RUN" == true ]]; then
        info "[DRY RUN] Would execute ralph loop with:"
        echo "  Project:    $PROJECT_DIR"
        echo "  PRD:        $PRD_FILE"
        echo "  Iterations: $MAX_ITERATIONS"
        echo "  Timeout:    ${ITERATION_TIMEOUT}s"
        echo "  Sudo:       $([[ -n "$SUDO_PASS_VAR" ]] && echo "enabled (\$$SUDO_PASS_VAR)" || echo "disabled")"
        if [[ -n "$CLAUDE_EXTRA_ARGS" ]]; then
            echo "  Claude:     $CLAUDE_EXTRA_ARGS"
        fi
        exit 0
    fi

    # Validate sudo password if enabled
    if [[ -n "$SUDO_PASS_VAR" ]]; then
        if [[ -z "${!SUDO_PASS_VAR:-}" ]]; then
            warn "Sudo password enabled but \$$SUDO_PASS_VAR is not set"
        fi
        # Export for use in core functions
        export SUDO_PASS_VAR
    fi

    # Export extra claude args for use in core functions
    export CLAUDE_EXTRA_ARGS

    validate_env

    # Create output directory
    mkdir -p "$OUTPUT_DIR"

    # Change to project directory
    cd "$PROJECT_DIR" || exit 1

    init_git
    show_config

    # Run the main loop
    run_loop
}

# Init command
cmd_init() {
    parse_init_args "$@"

    # Export extra claude args for use in generate_prd
    export CLAUDE_EXTRA_ARGS

    # Check for claude
    if ! command -v claude &>/dev/null; then
        error "claude CLI not found in PATH"
        echo "Install Claude Code: https://claude.ai/code"
        exit 1
    fi

    local prd_path="$INIT_OUTPUT_DIR/$PRD_FILE"

    # Check if PRD already exists
    if [[ -f "$prd_path" ]] && [[ "$DRY_RUN" != true ]]; then
        warn "PRD file already exists: $prd_path"
        read -r -p "Overwrite? [y/N] " response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Aborted."
            exit 0
        fi
    fi

    banner "RALPH ENGINE v$RALPH_VERSION"
    echo ""
    info "Generating PRD from goal..."
    echo ""
    echo -e "${CYAN}Goal:${NC}"
    echo "$GOAL_TEXT" | head -20
    if [[ $(echo "$GOAL_TEXT" | wc -l) -gt 20 ]]; then
        echo "  ... (truncated)"
    fi
    echo ""

    # Generate PRD
    local prd_content
    prd_content=$(generate_prd "$GOAL_TEXT")

    if [[ -z "$prd_content" ]]; then
        error "Failed to generate PRD"
        exit 1
    fi

    # Validate generated JSON
    if ! echo "$prd_content" | jq empty 2>/dev/null; then
        error "Generated PRD is not valid JSON"
        echo ""
        echo "Raw output:"
        echo "$prd_content" | head -50
        exit 1
    fi

    # Dry run - just show the PRD
    if [[ "$DRY_RUN" == true ]]; then
        info "[DRY RUN] Generated PRD:"
        echo ""
        echo "$prd_content" | jq .
        exit 0
    fi

    # Write PRD
    echo "$prd_content" | jq . > "$prd_path"

    local task_count
    task_count=$(echo "$prd_content" | jq '.tasks | length')

    echo ""
    success "PRD generated: $prd_path"
    info "Tasks: $task_count"
    echo ""
    echo "Next steps:"
    echo "  1. Review the PRD: cat $prd_path | jq ."
    echo "  2. Run Ralph:      ralph $INIT_OUTPUT_DIR"
    echo ""
}

# Status command
cmd_status() {
    parse_status_args "$@"

    if [[ ! -f "$PRD_FILE" ]]; then
        error "PRD file not found: $PRD_FILE"
        exit 1
    fi

    banner "RALPH ENGINE v$RALPH_VERSION"
    echo ""

    local project_name
    project_name=$(jq -r '.name // "Unnamed Project"' "$PRD_FILE")
    info "Project: $project_name"
    echo "  Directory: $PROJECT_DIR"
    echo "  PRD File:  $PRD_FILE"
    echo ""

    # Show progress
    local total completed pending
    total=$(jq '.tasks | length' "$PRD_FILE")
    completed=$(jq '[.tasks[] | select(.pass == true)] | length' "$PRD_FILE")
    pending=$((total - completed))

    local pct=0
    if [[ "$total" -gt 0 ]]; then
        pct=$((completed * 100 / total))
    fi

    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}Progress: $completed/$total tasks ($pct%)${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Show completed tasks
    if [[ "$completed" -gt 0 ]]; then
        echo -e "${GREEN}Completed Tasks:${NC}"
        jq -r '.tasks[] | select(.pass == true) | "  ✓ \(.id): \(.name)"' "$PRD_FILE"
        echo ""
    fi

    # Show pending tasks
    if [[ "$pending" -gt 0 ]]; then
        echo -e "${YELLOW}Pending Tasks:${NC}"
        jq -r '.tasks[] | select(.pass != true) | "  ○ \(.id): \(.name)"' "$PRD_FILE"
        echo ""
    fi

    # Show next available task
    echo -e "${CYAN}Next Available Task:${NC}"
    local next_task
    next_task=$(jq -r '
        .tasks as $all |
        [.tasks[] | select(.pass != true)] |
        map(select(
            .dependencies as $deps |
            ($deps == null or $deps == [] or
             ([$deps[] | . as $d | $all[] | select(.id == $d and .pass == true)] | length) == ($deps | length))
        )) |
        sort_by(.complexity // 5) |
        first |
        if . then "  \(.id): \(.name)" else "  (none available - check dependencies)" end
    ' "$PRD_FILE")
    echo "$next_task"
    echo ""
}

# Stack command
cmd_stack() {
    parse_stack_args "$@"

    if [[ ! -f "$PRD_FILE" ]]; then
        error "PRD file not found: $PRD_FILE"
        exit 1
    fi

    # Set MAIN_PRD_FILE for stack functions
    export MAIN_PRD_FILE="$PRD_FILE"

    banner "RALPH ENGINE v$RALPH_VERSION"

    # Use the show_stack_status function from ralph-core.sh
    show_stack_status

    # Show additional info about sub-PRDs in the project
    local sub_prds
    sub_prds=$(find "$(dirname "$PRD_FILE")" -maxdepth 1 -name "prd-*.json" -type f 2>/dev/null)

    if [[ -n "$sub_prds" ]]; then
        echo -e "${CYAN}Sub-PRD Files in Project:${NC}"
        echo ""
        while IFS= read -r sub_prd; do
            local sub_name parent_id completed total status_icon
            sub_name=$(basename "$sub_prd")
            parent_id=$(jq -r '.parentTaskId // "unknown"' "$sub_prd" 2>/dev/null)
            total=$(jq '.tasks | length' "$sub_prd" 2>/dev/null || echo 0)
            completed=$(jq '[.tasks[] | select(.pass == true)] | length' "$sub_prd" 2>/dev/null || echo 0)

            if jq -e '.completed == true' "$sub_prd" &>/dev/null; then
                status_icon="${GREEN}[DONE]${NC}"
            elif [[ "$completed" -eq "$total" ]] && [[ "$total" -gt 0 ]]; then
                status_icon="${GREEN}[DONE]${NC}"
            else
                status_icon="${YELLOW}[$completed/$total]${NC}"
            fi

            echo -e "  $status_icon $sub_name (parent: $parent_id)"
        done <<< "$sub_prds"
        echo ""
    else
        echo -e "${BLUE}No sub-PRD files found in project.${NC}"
        echo ""
    fi

    # Show expandable tasks in main PRD
    local expandable
    expandable=$(jq -r '
        .tasks[] |
        select(
            .expand == true or
            ((.complexity // 0) >= 4 and ((.actions // []) | length) >= 5)
        ) |
        "  \(.id): \(.name) (complexity: \(.complexity // "?"))"
    ' "$PRD_FILE" 2>/dev/null)

    if [[ -n "$expandable" ]]; then
        echo -e "${MAGENTA}Tasks Marked for Expansion:${NC}"
        echo "$expandable"
        echo ""
    fi
}

# Watch command
cmd_watch() {
    parse_watch_args "$@"

    if [[ ! -f "$PRD_FILE" ]]; then
        error "PRD file not found: $PRD_FILE"
        exit 1
    fi

    # Check for jq
    if ! command -v jq &>/dev/null; then
        error "jq not found in PATH"
        echo "Install jq: https://stedolan.github.io/jq/download/"
        exit 1
    fi

    # Run the watch display
    run_watch "$PRD_FILE" "$PROJECT_DIR" "$WATCH_REFRESH_INTERVAL"
}

# Flow command
cmd_flow() {
    parse_flow_args "$@"

    if [[ ! -f "$PRD_FILE" ]]; then
        error "PRD file not found: $PRD_FILE"
        exit 1
    fi

    # Check for jq
    if ! command -v jq &>/dev/null; then
        error "jq not found in PATH"
        echo "Install jq: https://stedolan.github.io/jq/download/"
        exit 1
    fi

    # Run the flow display
    run_flow "$PRD_FILE" "$PROJECT_DIR" "$FLOW_REFRESH_INTERVAL"
}

# Extend command
cmd_extend() {
    parse_extend_args "$@"

    # Export extra claude args for use in extend_prd
    export CLAUDE_EXTRA_ARGS

    # Check for claude
    if ! command -v claude &>/dev/null; then
        error "claude CLI not found in PATH"
        echo "Install Claude Code: https://claude.ai/code"
        exit 1
    fi

    # Check for jq
    if ! command -v jq &>/dev/null; then
        error "jq not found in PATH"
        echo "Install jq: https://stedolan.github.io/jq/download/"
        exit 1
    fi

    local prd_path="$EXTEND_OUTPUT_DIR/$PRD_FILE"

    # Check if PRD exists
    if [[ ! -f "$prd_path" ]]; then
        error "PRD file not found: $prd_path"
        echo ""
        echo "Use 'ralph init' to create a new project first."
        exit 1
    fi

    # Validate PRD JSON
    if ! jq empty "$prd_path" 2>/dev/null; then
        error "Invalid JSON in PRD file: $prd_path"
        exit 1
    fi

    # Check for completed tasks
    local completed_count
    completed_count=$(jq '[.tasks[] | select(.pass == true)] | length' "$prd_path")

    if [[ "$completed_count" -eq 0 ]]; then
        error "No completed tasks found in PRD."
        echo ""
        echo "Use 'ralph' to execute existing tasks before extending."
        exit 1
    fi

    banner "RALPH ENGINE v$RALPH_VERSION"
    echo ""
    info "Extending PRD with new tasks..."
    echo ""
    echo -e "${CYAN}New Goal:${NC}"
    echo "$EXTEND_GOAL_TEXT" | head -20
    if [[ $(echo "$EXTEND_GOAL_TEXT" | wc -l) -gt 20 ]]; then
        echo "  ... (truncated)"
    fi
    echo ""

    # Show current state
    local total_tasks
    total_tasks=$(jq '.tasks | length' "$prd_path")
    info "Current PRD: $completed_count/$total_tasks tasks complete"
    echo ""

    # Generate extension
    local extension_content
    extension_content=$(extend_prd "$EXTEND_GOAL_TEXT" "$prd_path")

    if [[ -z "$extension_content" ]]; then
        error "Failed to generate extension tasks"
        exit 1
    fi

    # Validate generated JSON
    if ! echo "$extension_content" | jq empty 2>/dev/null; then
        error "Generated extension is not valid JSON"
        echo ""
        echo "Raw output:"
        echo "$extension_content" | head -50
        exit 1
    fi

    # Extract task count for display
    local new_task_count
    new_task_count=$(echo "$extension_content" | jq '.tasks | length')

    # Dry run - just show the extension
    if [[ "$DRY_RUN" == true ]]; then
        info "[DRY RUN] Generated extension:"
        echo ""
        echo "$extension_content" | jq .
        echo ""
        info "Would add $new_task_count new tasks to $prd_path"
        exit 0
    fi

    # Merge extension into PRD
    local merged_count
    merged_count=$(merge_extension "$prd_path" "$extension_content")

    if [[ -z "$merged_count" ]] || [[ "$merged_count" -eq 0 ]]; then
        error "Failed to merge extension into PRD"
        exit 1
    fi

    local new_total
    new_total=$(jq '.tasks | length' "$prd_path")

    echo ""
    success "PRD extended: $prd_path"
    info "New tasks added: $merged_count"
    info "Total tasks: $new_total"
    echo ""
    echo "Next steps:"
    echo "  1. Review new tasks: jq '.tasks[-$merged_count:]' $prd_path"
    echo "  2. Run Ralph:        ralph $EXTEND_OUTPUT_DIR"
    echo ""
}

# Main entry point
main() {
    # Setup colors early (respects NO_COLOR)
    setup_colors

    # No arguments - show usage
    if [[ $# -eq 0 ]]; then
        # Check if prd.json exists in current directory
        if [[ -f "prd.json" ]]; then
            # Run with defaults
            cmd_run
        else
            usage
            exit 0
        fi
        return
    fi

    # Parse subcommand
    case "$1" in
        init)
            shift
            cmd_init "$@"
            ;;
        extend)
            shift
            cmd_extend "$@"
            ;;
        run)
            shift
            cmd_run "$@"
            ;;
        status)
            shift
            cmd_status "$@"
            ;;
        stack)
            shift
            cmd_stack "$@"
            ;;
        watch)
            shift
            cmd_watch "$@"
            ;;
        flow)
            shift
            cmd_flow "$@"
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            version
            exit 0
            ;;
        -*)
            # Options without subcommand = run
            cmd_run "$@"
            ;;
        *)
            # Directory argument = run
            cmd_run "$@"
            ;;
    esac
}

main "$@"
