#!/usr/bin/env bash
#
# ralph - Autonomous task executor for Claude Code
#
# Uses PRD-driven development with git as memory and Claude as executor.
# Each iteration: read PRD -> pick task -> execute -> commit -> verify
#

set -euo pipefail

# Version
readonly RALPH_VERSION="1.0.0"

# Determine script location for library loading
RALPH_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
readonly RALPH_ROOT

# Source core library
# shellcheck source=../lib/ralph-core.sh
source "${RALPH_ROOT}/lib/ralph-core.sh"

# Default configuration
DEFAULT_MAX_ITERATIONS=50
DEFAULT_TIMEOUT=900
DEFAULT_PRD_FILE="prd.json"
DEFAULT_OUTPUT_DIR="/tmp/ralph"

# Runtime configuration (set by parse_args)
MAX_ITERATIONS=""
ITERATION_TIMEOUT=""
PRD_FILE=""
OUTPUT_DIR=""
PROJECT_DIR=""
QUIET_MODE=false
NO_VERIFY=false
DRY_RUN=false

# Usage/help
usage() {
    cat <<EOF
ralph - Autonomous task executor for Claude Code

USAGE:
    ralph [OPTIONS] [PROJECT_DIR]

ARGUMENTS:
    PROJECT_DIR    Directory containing prd.json (default: current directory)

OPTIONS:
    -n, --max-iterations NUM    Maximum iterations (default: $DEFAULT_MAX_ITERATIONS)
    -t, --timeout SECONDS       Timeout per iteration (default: $DEFAULT_TIMEOUT)
    -p, --prd FILE              PRD file name (default: $DEFAULT_PRD_FILE)
    -o, --output DIR            Output directory for logs (default: $DEFAULT_OUTPUT_DIR)
    -q, --quiet                 Minimal output
        --no-verify             Skip verification step after each iteration
        --dry-run               Show what would be done without executing
    -h, --help                  Show this help message
    -v, --version               Show version

ENVIRONMENT VARIABLES:
    RALPH_MAX_ITERATIONS    Override default max iterations
    RALPH_TIMEOUT           Override default timeout
    RALPH_OUTPUT_DIR        Override default output directory
    NO_COLOR                Disable colored output

EXAMPLES:
    ralph                           # Run in current directory
    ralph ~/my-project              # Run in specific directory
    ralph -n 100 -t 1800            # 100 iterations, 30min timeout each
    ralph --dry-run                 # Preview without executing

PRD FILE FORMAT:
    The prd.json file should contain:
    {
        "tasks": [
            {
                "id": "T-100",
                "name": "Task name",
                "pass": false,
                "dependencies": [],
                ...
            }
        ]
    }

For more information, see: https://github.com/anthropics/claude-code

EOF
}

version() {
    echo "ralph $RALPH_VERSION"
}

# Parse command line arguments
parse_args() {
    # Apply environment variable defaults
    MAX_ITERATIONS="${RALPH_MAX_ITERATIONS:-$DEFAULT_MAX_ITERATIONS}"
    ITERATION_TIMEOUT="${RALPH_TIMEOUT:-$DEFAULT_TIMEOUT}"
    OUTPUT_DIR="${RALPH_OUTPUT_DIR:-$DEFAULT_OUTPUT_DIR}"
    PRD_FILE="$DEFAULT_PRD_FILE"
    PROJECT_DIR="."

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--max-iterations)
                MAX_ITERATIONS="$2"
                shift 2
                ;;
            -t|--timeout)
                ITERATION_TIMEOUT="$2"
                shift 2
                ;;
            -p|--prd)
                PRD_FILE="$2"
                shift 2
                ;;
            -o|--output)
                OUTPUT_DIR="$2"
                shift 2
                ;;
            -q|--quiet)
                QUIET_MODE=true
                shift
                ;;
            --no-verify)
                NO_VERIFY=true
                shift
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            -v|--version)
                version
                exit 0
                ;;
            -*)
                error "Unknown option: $1"
                echo "Use 'ralph --help' for usage information."
                exit 1
                ;;
            *)
                PROJECT_DIR="$1"
                shift
                ;;
        esac
    done

    # Validate numeric arguments
    if ! [[ "$MAX_ITERATIONS" =~ ^[0-9]+$ ]]; then
        error "Invalid max-iterations: $MAX_ITERATIONS (must be a number)"
        exit 1
    fi
    if ! [[ "$ITERATION_TIMEOUT" =~ ^[0-9]+$ ]]; then
        error "Invalid timeout: $ITERATION_TIMEOUT (must be a number)"
        exit 1
    fi

    # Resolve project directory
    PROJECT_DIR="$(cd "$PROJECT_DIR" 2>/dev/null && pwd)" || {
        error "Project directory not found: $PROJECT_DIR"
        exit 1
    }

    # Full path to PRD file
    PRD_FILE="$PROJECT_DIR/$PRD_FILE"
}

# Validate environment
validate_env() {
    # Check for claude CLI
    if ! command -v claude &>/dev/null; then
        error "claude CLI not found in PATH"
        echo "Install Claude Code: https://claude.ai/code"
        exit 1
    fi

    # Check for jq
    if ! command -v jq &>/dev/null; then
        error "jq not found in PATH"
        echo "Install jq: https://stedolan.github.io/jq/download/"
        exit 1
    fi

    # Check for git
    if ! command -v git &>/dev/null; then
        error "git not found in PATH"
        exit 1
    fi

    # Check PRD file exists
    if [[ ! -f "$PRD_FILE" ]]; then
        error "PRD file not found: $PRD_FILE"
        exit 1
    fi

    # Validate PRD JSON
    if ! jq empty "$PRD_FILE" 2>/dev/null; then
        error "Invalid JSON in PRD file: $PRD_FILE"
        exit 1
    fi

    # Check tasks array exists
    if ! jq -e '.tasks' "$PRD_FILE" &>/dev/null; then
        error "PRD file missing 'tasks' array"
        exit 1
    fi
}

# Initialize git if needed
init_git() {
    cd "$PROJECT_DIR" || exit 1

    if [[ ! -d ".git" ]]; then
        info "Initializing git repository..."
        git init
        git add -A
        git commit -m "Initial commit: PRD and project setup"
    fi
}

# Show configuration
show_config() {
    if [[ "$QUIET_MODE" == true ]]; then
        return
    fi

    local task_count
    task_count=$(jq '.tasks | length' "$PRD_FILE")
    local completed
    completed=$(jq '[.tasks[] | select(.pass == true)] | length' "$PRD_FILE")

    banner "RALPH ENGINE v$RALPH_VERSION"
    echo ""
    info "Configuration:"
    echo "  Project:      $PROJECT_DIR"
    echo "  PRD File:     $PRD_FILE"
    echo "  Tasks:        $completed/$task_count complete"
    echo "  Max Iter:     $MAX_ITERATIONS"
    echo "  Timeout:      ${ITERATION_TIMEOUT}s per iteration"
    echo "  Output:       $OUTPUT_DIR"
    echo "  Verify:       $([[ "$NO_VERIFY" == true ]] && echo "disabled" || echo "enabled")"
    echo ""
}

# Main entry point
main() {
    parse_args "$@"

    # Setup colors (respects NO_COLOR)
    setup_colors

    # Dry run mode
    if [[ "$DRY_RUN" == true ]]; then
        info "[DRY RUN] Would execute ralph loop with:"
        echo "  Project:    $PROJECT_DIR"
        echo "  PRD:        $PRD_FILE"
        echo "  Iterations: $MAX_ITERATIONS"
        echo "  Timeout:    ${ITERATION_TIMEOUT}s"
        exit 0
    fi

    validate_env

    # Create output directory
    mkdir -p "$OUTPUT_DIR"

    # Change to project directory
    cd "$PROJECT_DIR" || exit 1

    init_git
    show_config

    # Run the main loop
    run_loop
}

main "$@"
